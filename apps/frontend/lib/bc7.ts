// Ported from photopea/UTEX.js (https://github.com/photopea/UTEX.js)

const _subs2 = [
  "0011001100110011",
  "0001000100010001",
  "0111011101110111",
  "0001001100110111",
  "0000000100010011",
  "0011011101111111",
  "0001001101111111",
  "0000000100110111",
  "0000000000010011",
  "0011011111111111",
  "0000000101111111",
  "0000000000010111",
  "0001011111111111",
  "0000000011111111",
  "0000111111111111",
  "0000000000001111",
  "0000100011101111",
  "0111000100000000",
  "0000000010001110",
  "0111001100010000",
  "0011000100000000",
  "0000100011001110",
  "0000000010001100",
  "0111001100110001",
  "0011000100010000",
  "0000100010001100",
  "0110011001100110",
  "0011011001101100",
  "0001011111101000",
  "0000111111110000",
  "0111000110001110",
  "0011100110011100",
  "0101010101010101",
  "0000111100001111",
  "0101101001011010",
  "0011001111001100",
  "0011110000111100",
  "0101010110101010",
  "0110100101101001",
  "0101101010100101",
  "0111001111001110",
  "0001001111001000",
  "0011001001001100",
  "0011101111011100",
  "0110100110010110",
  "0011110011000011",
  "0110011010011001",
  "0000011001100000",
  "0100111001000000",
  "0010011100100000",
  "0000001001110010",
  "0000010011100100",
  "0110110010010011",
  "0011011011001001",
  "0110001110011100",
  "0011100111000110",
  "0110110011001001",
  "0110001100111001",
  "0111111010000001",
  "0001100011100111",
  "0000111100110011",
  "0011001111110000",
  "0010001011101110",
  "0100010001110111",
];
const _subs3 = [
  "0011001102212222",
  "0001001122112221",
  "0000200122112211",
  "0222002200110111",
  "0000000011221122",
  "0011001100220022",
  "0022002211111111",
  "0011001122112211",
  "0000000011112222",
  "0000111111112222",
  "0000111122222222",
  "0012001200120012",
  "0112011201120112",
  "0122012201220122",
  "0011011211221222",
  "0011200122002220",
  "0001001101121122",
  "0111001120012200",
  "0000112211221122",
  "0022002200221111",
  "0111011102220222",
  "0001000122212221",
  "0000001101220122",
  "0000110022102210",
  "0122012200110000",
  "0012001211222222",
  "0110122112210110",
  "0000011012211221",
  "0022110211020022",
  "0110011020022222",
  "0011012201220011",
  "0000200022112221",
  "0000000211221222",
  "0222002200120011",
  "0011001200220222",
  "0120012001200120",
  "0000111122220000",
  "0120120120120120",
  "0120201212010120",
  "0011220011220011",
  "0011112222000011",
  "0101010122222222",
  "0000000021212121",
  "0022112200221122",
  "0022001100220011",
  "0220122102201221",
  "0101222222220101",
  "0000212121212121",
  "0101010101012222",
  "0222011102220111",
  "0002111200021112",
  "0000211221122112",
  "0222011101110222",
  "0002111211120002",
  "0110011001102222",
  "0000000021122112",
  "0110011022222222",
  "0022001100110022",
  "0022112211220022",
  "0000000000002112",
  "0002000100020001",
  "0222122202221222",
  "0101222222222222",
  "0111201122012220",
];
const _anch2 = [
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 2, 0],
  [0, 8, 0],
  [0, 2, 0],
  [0, 2, 0],
  [0, 8, 0],
  [0, 8, 0],
  [0, 15, 0],
  [0, 2, 0],
  [0, 8, 0],
  [0, 2, 0],
  [0, 2, 0],
  [0, 8, 0],
  [0, 8, 0],
  [0, 2, 0],
  [0, 2, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 6, 0],
  [0, 8, 0],
  [0, 2, 0],
  [0, 8, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 2, 0],
  [0, 8, 0],
  [0, 2, 0],
  [0, 2, 0],
  [0, 2, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 6, 0],
  [0, 6, 0],
  [0, 2, 0],
  [0, 6, 0],
  [0, 8, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 2, 0],
  [0, 2, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 15, 0],
  [0, 2, 0],
  [0, 2, 0],
  [0, 15, 0],
];
const _anch3 = [
  [0, 3, 15],
  [0, 3, 8],
  [0, 15, 8],
  [0, 15, 3],
  [0, 8, 15],
  [0, 3, 15],
  [0, 15, 3],
  [0, 15, 8],
  [0, 8, 15],
  [0, 8, 15],
  [0, 6, 15],
  [0, 6, 15],
  [0, 6, 15],
  [0, 5, 15],
  [0, 3, 15],
  [0, 3, 8],
  [0, 3, 15],
  [0, 3, 8],
  [0, 8, 15],
  [0, 15, 3],
  [0, 3, 15],
  [0, 3, 8],
  [0, 6, 15],
  [0, 10, 8],
  [0, 5, 3],
  [0, 8, 15],
  [0, 8, 6],
  [0, 6, 10],
  [0, 8, 15],
  [0, 5, 15],
  [0, 15, 10],
  [0, 15, 8],
  [0, 8, 15],
  [0, 15, 3],
  [0, 3, 15],
  [0, 5, 10],
  [0, 6, 10],
  [0, 10, 8],
  [0, 8, 9],
  [0, 15, 10],
  [0, 15, 6],
  [0, 3, 15],
  [0, 15, 8],
  [0, 5, 15],
  [0, 15, 3],
  [0, 15, 6],
  [0, 15, 6],
  [0, 15, 8],
  [0, 3, 15],
  [0, 15, 3],
  [0, 5, 15],
  [0, 5, 15],
  [0, 5, 15],
  [0, 8, 15],
  [0, 5, 15],
  [0, 10, 15],
  [0, 5, 15],
  [0, 10, 15],
  [0, 8, 15],
  [0, 13, 15],
  [0, 15, 3],
  [0, 12, 15],
  [0, 3, 15],
  [0, 3, 8],
];

function readBit(data: Uint8Array, pos: { boff: number }) {
  const boff = pos.boff;
  pos.boff++;
  return (data[boff >> 3] >> (boff & 7)) & 1;
}

function readBits(data: Uint8Array, pos: { boff: number }, k: number) {
  let out = 0,
    ok = k;
  while (k !== 0) {
    out = out | (readBit(data, pos) << (ok - k));
    k--;
  }
  return out;
}

function rotate(sqr: Uint8Array, rot: number) {
  if (rot === 0) return;
  for (let i = 0; i < 64; i += 4) {
    let r = sqr[i];
    let g = sqr[i + 1];
    let b = sqr[i + 2];
    let a = sqr[i + 3];

    if (rot === 1) {
      const t = a;
      a = r;
      r = t;
    }
    if (rot === 2) {
      const t = a;
      a = g;
      g = t;
    }
    if (rot === 3) {
      const t = a;
      a = b;
      b = t;
    }

    sqr[i] = r;
    sqr[i + 1] = g;
    sqr[i + 2] = b;
    sqr[i + 3] = a;
  }
}

function write4x4(
  a: Uint8Array,
  w: number,
  h: number,
  sx: number,
  sy: number,
  b: Uint8Array,
) {
  for (let y = 0; y < 4; y++) {
    if (sy + y >= h) continue;

    const si = ((sy + y) * w + sx) << 2;
    const ti = y << 4;

    for (let x = 0; x < 4; x++) {
      if (sx + x >= w) continue;
      const pixS = si + (x << 2);
      const pixT = ti + (x << 2);
      a[pixS + 0] = b[pixT + 0];
      a[pixS + 1] = b[pixT + 1];
      a[pixS + 2] = b[pixT + 2];
      a[pixS + 3] = b[pixT + 3];
    }
  }
}

export function decodeBC7(
  data: Uint8Array,
  width: number,
  height: number,
): Uint8Array {
  const img = new Uint8Array(width * height * 4);
  let offset = 0;

  const pos = { boff: 0 };
  const sqr = new Uint8Array(4 * 4 * 4);

  const intp = [
    null,
    null,
    [0, 21, 43, 64],
    [0, 9, 18, 27, 37, 46, 55, 64],
    [0, 4, 9, 13, 17, 21, 26, 30, 34, 38, 43, 47, 51, 55, 60, 64],
  ] as number[][];

  const subs = [null, null, _subs2, _subs3];
  const ancs = [null, null, _anch2, _anch3];

  for (let y = 0; y < height; y += 4) {
    for (let x = 0; x < width; x += 4) {
      let mode = 0;
      while (((data[offset] >> mode) & 1) !== 1) mode++;

      pos.boff = (offset << 3) + mode + 1;

      const rot = mode === 4 || mode === 5 ? readBits(data, pos, 2) : 0;
      const indx = mode === 4 ? readBits(data, pos, 1) : 0;

      const prtlen = [4, 6, 6, 6, 0, 0, 0, 6][mode];
      const parti = readBits(data, pos, prtlen);

      let clen = [4, 6, 5, 7, 5, 7, 7, 5][mode];
      let alen = [0, 0, 0, 0, 6, 8, 7, 5][mode];
      const plen = [1, 1, 0, 1, 0, 0, 1, 1][mode];
      const pnts = [6, 4, 6, 4, 2, 2, 2, 4][mode];

      const clr = new Float32Array(4 * pnts);
      const rawClr = new Int32Array(4 * pnts);

      for (let i = 0; i < 4; i++) {
        const len = i === 3 ? alen : clen;
        for (let j = 0; j < pnts; j++)
          rawClr[i * pnts + j] = readBits(data, pos, len);
      }

      for (let j = 0; j < pnts; j++) {
        if (mode === 1 && (j & 1) === 1) pos.boff--;
        const bit = readBits(data, pos, plen);
        for (let i = 0; i < 3; i++)
          rawClr[i * pnts + j] = (rawClr[i * pnts + j] << plen) | bit;
        if (alen !== 0)
          rawClr[3 * pnts + j] = (rawClr[3 * pnts + j] << plen) | bit;
      }
      clen += plen;
      if (alen !== 0) alen += plen;

      for (let i = 0; i < 4; i++) {
        const len = i === 3 ? alen : clen;
        const cf = len === 0 ? 0 : 1 / ((1 << len) - 1);
        for (let j = 0; j < pnts; j++)
          clr[i * pnts + j] = rawClr[i * pnts + j] * cf;
      }
      if (alen === 0) for (let j = 0; j < pnts; j++) clr[3 * pnts + j] = 1;

      const scnt = [3, 2, 3, 2, 1, 1, 1, 2][mode];
      let cind = [3, 3, 2, 2, 2, 2, 4, 2][mode];
      let aind = [0, 0, 0, 0, 3, 2, 0, 0][mode];

      let smap = "0000000000000000";
      let anci = [0, 0, 0];
      if (scnt !== 1) {
        smap = subs[scnt]![parti];
        anci = ancs[scnt]![parti];
      }

      let coff = pos.boff;
      let aoff = coff + 16 * cind - scnt;
      if (indx === 1) {
        const t = coff;
        coff = aoff;
        aoff = t;
        const t2 = cind;
        cind = aind;
        aind = t2;
      }

      let cint = intp[cind]!;
      pos.boff = coff;

      for (let i = 0; i < 64; i += 4) {
        const ss = smap.charCodeAt(i >> 2) - 48;
        const first = anci[ss] === i >> 2 ? 1 : 0;
        const code = readBits(data, pos, cind - first);

        const f = cint[code] / 64;
        const r =
          (1 - f) * clr[0 * pnts + 2 * ss + 0] + f * clr[0 * pnts + 2 * ss + 1];
        const g =
          (1 - f) * clr[1 * pnts + 2 * ss + 0] + f * clr[1 * pnts + 2 * ss + 1];
        const b =
          (1 - f) * clr[2 * pnts + 2 * ss + 0] + f * clr[2 * pnts + 2 * ss + 1];
        const a =
          (1 - f) * clr[3 * pnts + 2 * ss + 0] + f * clr[3 * pnts + 2 * ss + 1];

        sqr[i] = Math.floor(r * 255);
        sqr[i + 1] = Math.floor(g * 255);
        sqr[i + 2] = Math.floor(b * 255);
        sqr[i + 3] = Math.floor(a * 255);
      }

      cint = intp[aind]!;
      pos.boff = aoff;

      if (aind !== 0)
        for (let i = 0; i < 64; i += 4) {
          const ss = smap.charCodeAt(i >> 2) - 48;
          const first = anci[ss] === i >> 2 ? 1 : 0;
          const code = readBits(data, pos, aind - first);

          const f = cint[code] / 64;
          const a =
            (1 - f) * clr[3 * pnts + 2 * ss + 0] +
            f * clr[3 * pnts + 2 * ss + 1];
          sqr[i + 3] = Math.floor(a * 255);
        }

      rotate(sqr, rot);
      write4x4(img, width, height, x, y, sqr);

      offset += 16;
    }
  }
  return img;
}
